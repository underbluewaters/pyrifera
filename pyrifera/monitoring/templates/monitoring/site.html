{% extends 'common/panel.html' %}
{% block title %}{{site.name}}{% endblock title %}
{% block panel %}
    <style type="text/css" media="screen">
    svg {
        shape-rendering: auto;
    }
    
        .rule line {
          stroke: #eee;
        }

        .rule line.axis {
          stroke: #000;
        }

        .area {
          fill: lightsteelblue;
        }

        .line, circle.area {
          fill: none;
          stroke: steelblue;
          stroke-width: 0.75px;
        }

        circle.area {
          fill: #fff;
        }
    </style>
    <script type="text/javascript" charset="utf-8">
        lingcod.onShow(function(){
            // a- tags with class "myPlayer" are transformed into video players
            flowplayer("a.myPlayer", "http://releases.flowplayer.org/swf/flowplayer-3.2.5.swf");
            
            $('a.years').click(function(e){
                $('.nowPlaying').removeClass('nowPlaying');
                $('a.myPlayer').hide();
                $($(this).attr('data-video')).show();
                $(this).addClass('nowPlaying');
                e.preventDefault();
                return false;
            });
            
            $('.years:first').click();
            
            {% if temperatures %}
            var data = [{{temperatures|safe}}];
            
            var monthly_average = [];
            for(var i = 0; i<data.length; i++){
                var date = data[i].date;
                var first = new Date(date.getFullYear(), date.getMonth(), 1, 1, 1, 1);
                if(!monthly_average[first]){
                    monthly_average[first] = {
                        n: 0,
                        sum: 0,
                        average: null
                    };
                }
                monthly_average[first].n += 1;
                monthly_average[first].sum += data[i].celsius;
            }

            
            var monthly = [];
            for(var date in monthly_average){
                var r = monthly_average[date];
                r.average = r.sum / r.n;
                r.celsius = r.average;
                r.date = new Date(date);
                monthly.push(r);
            }
            window.monthly = monthly;

            d3.select('#temp')
                .append('h3')
                    .text('Temperature')
            
            var w = 430,
                h = 90,
                min = d3.min(data, function(d){return d.celsius}),
                max = d3.max(data, function(d){return d.celsius}),
                earliest = d3.min(data, function(d){return d.date}),
                latest = d3.max(data, function(d){return d.date}),
                pv = 25,
                ph = 20,
                x = d3.scale.linear().domain([earliest, latest]).range([0, w]),
                y = d3.scale.linear().domain([min, max]).range([h, 0])
                daily_color = "#B7C5CD",
                monthly_color = "#2A4AAF";
            console.log(latest);
			console.log(earliest);
            var years = [];
			if(earliest.getDay() == 1 && earliest.getMonth() == 1){
				years.push([new Date(earliest.getFullYear(), 1, 1, 1, 1, 1)]);				
			}
            var c = earliest;
            while(c.getFullYear() < latest.getFullYear()){
                c = new Date(c.getFullYear() + 1, 1, 1, 1, 1, 1);
                years.push(new Date(c.getTime()));
            }
            window.years = years;

            var vis = d3.select('#temp')
                .append('svg:svg')
                    .attr('id', 'panel')
                    .attr('width', w + ph * 2)
                    .attr('height', h + pv * 2)
                    .on("mousemove", update)
                    .on('mouseout', function(){update(true)})
                    // .append("svg:g")
                    //   .attr("transform", "translate(" + ph + "," + pv + ")");
            
            vis.selectAll("svg:path")
                .data([data]).enter()
                .append('svg:path')
              .attr("d", d3.svg.line()
                .x(function(d) { return x(d.date) + ph; })
                .y(function(d) { return y(d.celsius)}))
              .attr('style', 'stroke: '+daily_color+';')
              .attr('class','line')
              
              vis.selectAll("svg:path")
                  .data([monthly]).enter()
                  .append('svg:path')
                .attr("d", d3.svg.line()
                  .x(function(d) { return x(d.date) + ph; })
                  .y(function(d) { return y(d.celsius)})
                  .interpolate('cardinal')
                  .tension(0.65))
                .attr('style', 'stroke: '+monthly_color+';')
                .attr('class','line')
            
            var daily_label = vis.append("svg:text")
                .attr('id', 'daily_legend')
                .attr("y", 0)
                .attr("x", (w) - 110)
                .attr("fill", daily_color)
                .attr("text-anchor", "end")
                .text('● daily avg')
                .attr('style', 'font-size: 0.8em;')

            var monthly_label = vis.append("svg:text")
                .attr('id', 'monthly_legend')
                .attr("y", 0)
                .attr("x", w)
                .attr("fill", monthly_color)
                .attr("text-anchor", "end")
                .text('● monthly avg')
                .attr('style', 'font-size: 0.8em;')
                .attr('opacity', '0.8')
            
            
			var max_year_labels = (w + ph * 2) / (21 + 25);
			

			var year_labels = vis.selectAll('text.year_label')
                .data(years).enter()
                .append('svg:text')
                .text(function(d){return d.getFullYear()})
                .attr('x', function(d){return x(d) + ph})
                .attr('y', h + 24)
				.attr('opacity', function(d, i){ return i % Math.round(years.length / max_year_labels) ? '0' : '1'})
                .attr('style', 'font-size: 0.7em;text-anchor:middle;')

            var year_tics = vis.selectAll('line.year')
                .data(years).enter()
                .append('svg:line')
                .attr('x1', function(d){return x(d) + ph})
                .attr('y1', h + 10)
                .attr('x2', function(d){return x(d) + ph})
                .attr('y2', h + 5)
				.attr('style', 'stroke:black;stroke-width:1;')

            var month_tics = vis.selectAll('line.month')
                .data(monthly).enter()
                .append('svg:line')
                .attr('x1', function(d){return x(d.date) + ph})
                .attr('y1', h + 8)
                .attr('x2', function(d){return x(d.date) + ph})
                .attr('y2', h + 7)
				.attr('style', 'stroke:black;stroke-width:0.5;')
            
            var selectedData = [];
            var selectedDaily = [];
            var selectedMonthly = [];
            var uscale = (latest.getTime() - earliest.getTime()) / w + ph * 2;
            var timeout;
            var date = null;
            function update(a) {
                if(timeout){
                    clearTimeout(timeout);
                }
                date = new Date(earliest.getTime() + uscale * (d3.svg.mouse(d3.select('#panel')[0][0])[0] - ph));
                timeout = setTimeout(function(){
                    var original = latest;
                    if(selectedData[0]){
                        original = new Date(selectedData[0].getTime());
                    }
                    selectedData.pop();
                    timeout = null;
                    if(!a){
                        selectedData.push(date);
                    }
                    var selected = vis.selectAll("line.selected")
                        .data(selectedData, function(d){return d.getTime()});

                    selected.enter()
                        .insert('svg:line', 'path')
                            .attr('class', 'selected')
                            .attr('stroke', 'white')
                            .attr('stroke-width', '8px')
                            .attr('x1', function(d){return x(original) + ph})
                            .attr('x2', function(d){return x(original) + ph})
                            .attr("y1", 0)
                            .attr("y2", h)
                            .transition().duration(300)
                                .attr('x1', function(d, i, b){return x(d) + ph})
                                .attr('x2', function(d, i, b){return x(d) + ph})
                    
                    selected.exit().remove();
                    
                    var selected_date = new Date(date.getFullYear(), date.getMonth(), date.getDay(), 0, 0, 0);
                    var selected_record = false;
                    for(var i = 0; i<data.length;i++){
                        if(data[i].date.getTime() == selected_date.getTime()){
                            selected_record = data[i];
                            break;                            
                        }
                    }
                    selectedDaily.pop();             
                    if(selected_record){
                        if(!a){
                            selectedDaily.push(selected_record);
                        }
                    }
                    var dailypin = vis.selectAll('circle.dailypin')
                        .data(selectedDaily, function(d){return d.date.getTime()})
                    
                    dailypin.enter()
                        .insert('svg:circle')
                            .attr('class', 'dailypin')
                            .attr('stroke', 'black')
                            .attr('stroke-width', 0.5)
                            .attr('cx', function(d){return x(d.date) + ph;})
                            .attr('cy', function(d){return y(d.celsius);})
                            .attr('r', 2)
                            .attr('fill', '#CCC')
                            
                    dailypin.exit().remove();
                    
                    var selected_month = new Date(date.getFullYear(), date.getMonth(), 1, 1, 1, 1);
                    var selected_month_record = false;
                    for(var i = 0; i<monthly.length;i++){
                        if(monthly[i].date.getTime() == selected_month.getTime()){
                            selected_month_record = monthly[i];
                            break;             
                        }
                    }
                    selectedMonthly.pop();             
                    if(selected_month_record){
                        if(!a){
                            selectedMonthly.push(selected_month_record);
                        }
                    }
                    var monthlypin = vis.selectAll('circle.monthly')
                        .data(selectedMonthly, function(d){return d.date.getTime()})
                    
                    monthlypin.enter()
                        .insert('svg:circle')
                            .attr('class', 'monthly')
                            .attr('stroke', 'black')
                            .attr('stroke-width', 0.5)
                            .attr('cx', function(d){return x(d.date) + ph;})
                            .attr('cy', function(d){return y(d.celsius);})
                            .attr('r', 2)
                            .attr('fill', '#004080')

                    monthlypin.exit().remove();
                    
                    
                    if(!a){
                        vis.select('#monthly_legend')
                            .text(selected_month_record ? Math.round(selected_month_record.celsius * 100) / 100 + ' monthly avg' : '● monthly avg')
                        vis.select('#daily_legend')
                            .text(selected_record ? Math.round(selected_record.celsius * 100) / 100 + ' daily avg' : '● daily avg')
                    }else{
                        vis.select('#monthly_legend')
                            .text('● monthly avg')                        
                        vis.select('#daily_legend')
                            .text('● daily avg')                        
                    }
                }, 5);
            }
            {% endif %}
        });
    </script>
    <h1>{{site.name}}</h1>
    <div class="tabs">
        <ul>
            <li><a href="#SiteInfo"><span>Site Info</span></a></li>
            <li><a href="{% url monitoring.views.species_lists site.pk %}"><span>Species Lists</span></a></li>
            <li><a href="#Streamgraphs"><span>Streamgraphs</span></a></li>
            <li><a href="#SizeFrequency"><span>SizeFrequency</span></a></li>
        </ul>
        <div id="SiteInfo">
            <p class="project">A {{site.project.name}} Site</p>
            <p class="dates"><a href="http://intertidalweb.org/subtidal/subtidal/pages/timeline.php#SCI_PELICAN">1985-2009 <- graphic display here</a></p>
            <h4>sampled here</h4>
            <ul>
                {% for protocol in site.protocols.all %}
                    <li>{{protocol.name}}</li>
                {% endfor %}
            </ul>
            <div id="temp"></div>
            <div class="videos">
                <h2>Underwater Video Transects</h2>
                {% for video in site.videos.all %}
                    <a class="myPlayer" id="video_{{video.pk}}"
                    	href="{{video.url}}" {% if video.full_thumbnail %}style="background-image:url('{{video.full_thumbnail}}');"{% endif %}>
                        <img src="{{MEDIA_URL}}/images/play_video.png" alt="{{video.site.name}} - {{video.year}}"/>
                    </a>
                {% endfor %}
                {% for video in site.videos.all %}
                    <a class="years" data-video="#video_{{video.pk}}" href="#video_{{video.pk}}">{{video.year}}</a>
                {% endfor %}
            </div>
        </div>
        <div id="Streamgraphs">
            {% for protocol in site.protocols.all %}
                <h4><a target="_blank" href="{% url monitoring.views.streamgraph site.pk protocol.pk %}">{{protocol.name}}</a></h4>
            {% endfor %}
        </div>
        <div id="SizeFrequency">
            <p>....</p>
        </div>
    </div>
{% endblock panel %}