{% extends 'common/panel.html' %}
{% block title %}{{site.name}} - Create a Chart{% endblock title %}
{% block panel %}
<style type="text/css" media="screen">
  #createAChart {
    width:95%;
    height:310px;
    margin-left:auto;
    margin-right:auto;
  }
  
  #chartTaxa li {
      font-size:14px;
      padding:5px 0px;
      position:relative;
      margin-left:5px;
      width:410px;
  }
  
  #chartTaxa li span {
      width:20px;
      height:10px;
      position:absolute;
      left:-30px;
      top:8px;
  }
  
  #chartTaxa .remove {
      position:absolute;
      right:0px;
  }
  
  #addTaxa {
      position:absolute;
      right:20px;
  }
  
  .chartspinner {
      position:absolute;
      right:130px;
      margin-top:-3px;
      display:none;
  }
</style>
<script type="text/javascript" charset="utf-8">
    
    function pickName(d){
        return d.common_name || d.scientific_name;
    }
    
    var SiteTimeChart = function(chartEl, listEl, spinner){
        this.list = listEl;
        this.spinner = spinner;
        this.chart = d3.select(chartEl)
            .append("svg:svg")
                .attr("width", this.width)
                .attr("height", this.height)
        this.g = this.chart.append("svg:g")
            .attr("transform", "translate(0, "+this.height+")");
        
        this.line = d3.svg.line()
            .x(function(d,i) { return this.x(i); })
            .y(function(d) { return -1 * d; })
    }
    
    _.extend(SiteTimeChart.prototype, {

        width: 440,
        height: 300,
        margin: 20,
        'margin-left': 40,
        taxa: [],
        limit: 6,        
        x: d3.scale.linear(),
        y: {},
        lines: {},
        colorScale: d3.scale.category20(),
        
        addTaxon: function(data){
            if(this.taxa.length >= this.limit){
                alert('You cannot add more than ' + 
                    this.limit + ' taxa to the chart.');
                return;
            }
            if(!_.any(this.taxa, function(t){ return t.id === data.id; })){
                this.taxa.push(data);
                this.renderList();                
            }
            this.fetchRecords(data);
        },
        
        removeTaxon: function(id){
            // Remove taxon matching id from list
            this.taxa = _.select(this.taxa, 
                function(d){ return d.id !== id; });
            this.renderList();
            this.renderChart();
        },
        
        renderList: function(){
            // render list
            var elements = d3.select(this.list)
                .selectAll('li')
                    .data(this.taxa, function(d){ return d.id + d.protocol })
                    
            var that = this;
            
            var list_elements = elements.enter()
                .append('li')
                    .text(pickName)
            
            list_elements
                    .append('a')
                        .attr('class', 'remove')
                        .text('remove')
                        .attr('href', '#')
                        .attr('data-id', function(d){ return d.id; })
                        .on('click', function(d){
                            that.removeTaxon(d.id);
                        })
            
            list_elements.append('span')
                .text(' ')
                .style('background-color', function(d, i){ return that.colorScale(d.id); })
                
            elements.exit()
                .style('background-color', '#EACBCF')
                .transition()
                    .duration(200)
                    .style('opacity', function(d, i){ return i; })
                    .style('-moz-opacity', function(d, i){ return i; })
                    .style('-webkit-opacity', function(d, i){ return i; })
                    .remove()
        },
        
        fetchRecords: function(taxon, cback){
            this.spin();
            var that = this;
            var url = taxon['records-url'].replace('99999999999', {{site.pk}});
            $.getJSON(url, function(data){
                that.unspin();
                taxon['records'] = data;
                that.renderChart();
            });
        },
        
        yAxisX: function(i){
            return (25 * i) + (40 * (i + 1));
        },
        
        renderChart: function(){
            // Calculate min/max dates, unique units
            var all_records = _.flatten(_.pluck(this.taxa, 'records'));
            var years = _.pluck(all_records, 'year');
            var units = _.uniq(_.pluck(all_records, 'unit'));

            // Adjust x scale to account for y-axis labels
            var scale_margin = this.yAxisX(units.length - 1);
            this.x.range([0 + scale_margin + 15, this.width - this.margin])
                .domain([_.min(years), _.max(years)]);

            
            // Remove existing y-axis labels
            this.g.selectAll('.yAxis').remove();
            var that = this;
            _.each(units, function(unit, i){
                // Create a new scale for this unit
                var scale = that.y[unit] = d3.scale.linear().range(
                    [0 + that.margin, that.height - that.margin]);
                // Get all records using this scale
                var filtered = _.select(all_records, 
                    function(r){ return r.unit == unit });
                var means = _.pluck(filtered, 'mean');
                // Set min/max value for scale based on records
                scale.domain([_.min(means), _.max(means)]);

                var classname = unit.replace(/[^A-z]/g, '');                

                var majorTics = scale.ticks(4);
                // Add y-axis labels
                that.g.selectAll("."+classname)
                    .data(majorTics)
                    .enter().append('svg:text')
                        .attr('class', classname + ' yLabels yAxis')
                        .text(function(d){return (Math.round(d*100)/100).toString()})
                        .attr('x', that.yAxisX(i))
                        .attr('y', function(d){ return scale(d) * -1;})
                        .attr('text-anchor', 'end')
                        .style('text-align', 'right')
                        .style('width', '4em')
                        .attr("dy", 4)

                // Add y-xis major tics
                that.g.selectAll("."+classname+"Tic")
                    .data(majorTics)
                    .enter().append('svg:line')
                        .attr('class', classname+"Tic yAxis")
                        .attr('x1',that.yAxisX(i)+1)
                        .attr('x2', that.yAxisX(i)+6)
                        .attr('y1', function(d){return scale(d) * -1})
                        .attr('y2', function(d){return scale(d) * -1})
                        .style('stroke', 'black')                        
                
                that.g.append('svg:line')
                    .attr('class', 'yAxis')
                    .attr('x1', that.yAxisX(i) + 6)
                    .attr('x2', that.yAxisX(i) + 6)
                    .attr('y1', scale(_.max(means)) * -1)
                    .attr('y2', scale(0) * -1)
                    .style('stroke', '#AFB6BD')
                
                var x = that.yAxisX(i) - 30;
                var y = (that.height / 2) * -1;
                
                that.g.append('svg:text')
                    .attr('transform', 'rotate(-90 '+x+' '+y+')')
                    .attr('class', 'yTics unitLabel yAxis')
                    .text(unit)
                    .attr('x', x)
                    .attr('y', y)
                
                that.lines[unit] = d3.svg.line()
                    .x(function(d) { return that.x(d.year); })
                    .y(function(d) { return -1 * that.y[unit](d.mean); });
            });
            
            // Remove all components of existing x-axis labels
            this.g.selectAll(".xLabel, .xTic, .xAxis").remove();

            var majorTics = that.x.ticks(5);
            // Add year labels
            this.g.selectAll(".xLabel")
                .data(majorTics)
                .enter().append("svg:text")
                .attr("class", "xLabel")
                .text(String)
                .attr("x", that.x)
                .attr("y", 0)
                .attr("text-anchor", "middle")
                
            // Add "tic-line"
            this.g.selectAll(".xTic")
                .data(that.x.ticks(that.x.domain()[1] - that.x.domain()[0]))
                .enter().append('svg:line')
                    .attr('x1', that.x)
                    .attr('x2', that.x)
                    .attr('y1', function(d){return _.include(majorTics, d) ? -10 : -13;})
                    .attr('y2', -15)
                    .attr('class', 'xTic')
                    .style('stroke', 'black')

            if(all_records.length){
                this.g.append('svg:line')
                    .attr('class', 'xAxis')
                    .attr('x1', that.x.range()[0])
                    .attr('x2', that.x.range()[1])
                    .attr('y1', -15)
                    .attr('y2', -15)
                    .style('stroke', '#AFB6BD')                
            }

            this.g.selectAll('path.taxon').remove();

            // Now render the data
            var taxa = this.g.selectAll('path.taxon')
                .data(this.taxa, function(d){ return d.id + d.protocol })
                
            taxa.enter().append('svg:path')
                .attr('class', 'taxon')
                .style('stroke', function(d){return that.colorScale(d.id);})
                .style('fill', 'none')
                .attr('d', function(d){ return that.lines[d.unit](d.records);})
            
            taxa.exit().remove();
            
            // Add dots
            this.g.selectAll('circle.record').remove();
            this.g.selectAll('circle.record')
                .data(all_records).enter().append('svg:circle')
                    .attr('class', 'record')
                    .attr('cx', function(d){return that.x(d.year);})
                    .attr('cy', function(d){return -1 * that.y[d.unit](d.mean)})
                    .attr('r', '3')
                    .style('stroke', 'white')
                    .style('fill', function(d){return that.colorScale(d.taxon);})
                    .on('mouseover', that.mouseover)
                    .on('mouseout', that.mouseout)
                    .attr('title', function(d){return pickName(d);})
        },
        
        mouseover: function(d, i){
            d3.select(this)
                .style('stroke', '#FFED25')
                .style('stroke-width', '3')
                .attr('r', 5)
        },
        
        mouseout: function(d, i){
            d3.select(this)
                .style('stroke', 'white')
                .style('stroke-width', '1')
                .attr('r', 3)
        },
        
        spin: function(){
            this.spinner.show();
        },
        
        unspin: function(){
            this.spinner.hide();
        }
    });
    
</script>
<script type="text/javascript" charset="utf-8">
    $('#search_panel a.close').click();
    lingcod.onShow(function(){
        $('#addTaxa').unbind('click');
        
        moveSearchToForeground();
        
        var chart = new SiteTimeChart(
            $('#createAChart')[0], $('#chartTaxa')[0], $('.chartspinner'));

        setSearchChoiceCallback(function(choice){
            $('#search_panel a.close').click()
            chart.addTaxon(choice.data());
        });        
        
        $('#addTaxa').click(function(){
            var href = "{% url monitoring.views.search 1 %}";
            search_panel.showUrl(href, {});
        });
        
    });
    
    lingcod.beforeDestroy(function(){
        moveSearchToBackground();
        clearSearchChoiceCallback();
    });
    
</script>

  {% if not is_ajax and not request.is_ajax %}
    <h1>{{site.name}} - Create a Chart</h1>
  {% endif %}

  <div id="createAChart">
  </div>
  <ul id="chartTaxa">
  </ul>
  <hr>
  <img class="chartspinner" src="{{MEDIA_URL}}common/images/ajax-loader.gif" width="32" height="32">
  <a id="addTaxa" href="#" class="button" onclick="this.blur(); return false;">
    <span>Add Taxa</span>
  </a>

{% endblock panel %}